<h2>Shopping Cart</h2>

<div *ngIf="loading" style="padding: 20px; text-align: center;">
  <p>Loading cart...</p>
</div>

<div *ngIf="error" style="padding: 15px; background-color: #ffebee; color: #c62828; margin: 20px 0; border: 2px solid #c62828; border-radius: 4px; font-weight: bold;">
  <strong>Error:</strong> {{ error }}
</div>

<div *ngIf="successMessage" style="padding: 15px; background-color: #e8f5e9; color: #2e7d32; margin: 20px 0; border: 2px solid #4CAF50; border-radius: 4px; font-weight: bold;">
  âœ“ {{ successMessage }}
</div>

<div *ngIf="cartItems.length > 0 && !loading" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 4px;">
  <p style="margin: 5px 0;"><strong>Items in Cart:</strong> {{ getCartItemCount() }}</p>
  <p style="margin: 5px 0;"><strong>Cart Total:</strong> ${{ calculateTotal() | number:'1.2-2' }}</p>
  <button
    (click)="checkoutAll()"
    [disabled]="checkingOutAll"
    style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px;"
    [style.opacity]="checkingOutAll ? '0.6' : '1'"
  >
    {{ checkingOutAll ? 'Processing...' : 'Purchase All Items' }}
  </button>
</div>

<table border="1" *ngIf="cartItems.length > 0 && !loading" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
  <thead>
    <tr style="background-color: #f0f0f0;">
      <th style="padding: 8px;">Item ID</th>
      <th style="padding: 8px;">Part</th>
      <th style="padding: 8px;">Supplier</th>
      <th style="padding: 8px;">Quantity</th>
      <th style="padding: 8px;">Unit Price</th>
      <th style="padding: 8px;">Subtotal</th>
      <th style="padding: 8px;">Tax</th>
      <th style="padding: 8px;">Total</th>
      <th style="padding: 8px;">Date Added</th>
      <th style="padding: 8px;">Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let item of cartItems">
      <td style="padding: 8px;">{{ item.orderId }}</td>
      <td style="padding: 8px;">
        <div *ngFor="let orderItem of item.items">
          <strong>{{ orderItem.part.partId }}</strong><br>
          <small>{{ orderItem.part.partName }}</small>
        </div>
      </td>
      <td style="padding: 8px;">
        <div *ngFor="let orderItem of item.items">
          <span *ngIf="!editingItem[item.orderId]">{{ orderItem.supplierName || 'N/A' }}</span>
          <select *ngIf="editingItem[item.orderId]"
                  [(ngModel)]="selectedSupplier[item.orderId]"
                  style="width: 150px;">
            <option *ngFor="let option of supplierOptions[item.orderId]" [ngValue]="option.partSupplierId">
              {{ option.supplierName }} (${{ option.partCost | number:'1.2-2' }})
            </option>
          </select>
        </div>
      </td>
      <td style="padding: 8px;">
        <div *ngFor="let orderItem of item.items">
          {{ orderItem.quantity }}
        </div>
      </td>
      <td style="padding: 8px;">
        <div *ngFor="let orderItem of item.items">
          ${{ orderItem.unitPrice | number:'1.2-2' }}
        </div>
      </td>
      <td style="padding: 8px;">
        <div *ngFor="let orderItem of item.items">
          ${{ (orderItem.unitPrice * orderItem.quantity) | number:'1.2-2' }}
        </div>
      </td>
      <td style="padding: 8px;">${{ item.taxAmount | number:'1.2-2' }}</td>
      <td style="padding: 8px;"><strong>${{ item.totalAmount | number:'1.2-2' }}</strong></td>
      <td style="padding: 8px;">{{ item.createdAt | date:'short' }}</td>
      <td style="padding: 8px;">
        <div *ngFor="let orderItem of item.items">
          <button
            *ngIf="!editingItem[item.orderId]"
            (click)="startEditItem(item)"
            style="padding: 6px 12px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; margin-bottom: 5px;"
            title="Change supplier"
          >
            Update Supplier
          </button>
          <button
            *ngIf="editingItem[item.orderId]"
            (click)="updateItemSupplier(item)"
            [disabled]="!selectedSupplier[item.orderId] || updating[item.orderId]"
            style="padding: 6px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; margin-bottom: 5px;"
            title="Save changes"
          >
            {{ updating[item.orderId] ? 'Saving...' : 'Save' }}
          </button>
          <button
            *ngIf="editingItem[item.orderId]"
            (click)="cancelEditItem(item.orderId)"
            style="padding: 6px 12px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 5px;"
            title="Cancel"
          >
            Cancel
          </button>
        </div>
        <button
          (click)="checkoutItem(item.orderId)"
          [disabled]="checkingOut[item.orderId]"
          style="padding: 6px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; margin-top: 5px;"
          [style.opacity]="checkingOut[item.orderId] ? '0.6' : '1'"
          title="Purchase this item"
        >
          {{ checkingOut[item.orderId] ? 'Processing...' : 'Purchase' }}
        </button>
        <button
          (click)="deleteItem(item.orderId)"
          [disabled]="deleting[item.orderId]"
          style="padding: 6px 12px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;"
          [style.opacity]="deleting[item.orderId] ? '0.6' : '1'"
          title="Remove from cart"
        >
          {{ deleting[item.orderId] ? 'Removing...' : 'Remove' }}
        </button>
      </td>
    </tr>
  </tbody>
</table>

<div *ngIf="cartItems.length === 0 && !loading" style="padding: 20px; text-align: center;">
  <p>Your cart is empty.</p>
  <p><a routerLink="/">Search for parts</a> to add items to your cart.</p>
</div>

